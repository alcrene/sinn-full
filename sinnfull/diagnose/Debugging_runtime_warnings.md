# Debugging runtime warnings

I've found the following useful when debugging Theano warnings. 

## Launch the debugger on an error or warning

```bash
THEANO_FLAGS="mode=FAST_COMPILE" smttask run --no-record --pdb <problematic taskname>
```

The flag `FAST_COMPILE` indicates to use pure Python implementations of opts (and so doing, compiles faster). This tends to print more intelligible error messages. Moreover, it allows use of the interactive debugger.

The use of the `--pdb` flag will launch the debugger at the location of an error, if one occurs.

However, if the problem is a warning, the debugger won't launch. For example, perhaps running the code produces the following warning:

```
RuntimeWarning: invalid value encountered in add
```

To convert this warning into an error, change the line above to the following:

```bash
THEANO_FLAGS="mode=FAST_COMPILE" PYTHONWARNINGS="error:divide by zero" smttask run --no-record --pdb <problematic taskname>
```

This will convert an `warning` to an `error`, if and only if the warning's message contains the string `"divide by zero"`. Another message one might want want to catche is `"invalid value encountered in "` (the last word may be `"add"`, `"mul"`, etc – this will catch all of those). This can happen if evalutaions produce infinities or NaNs.

## What to do once the debugger has launched

If you filtered for `"divide by zero"` or `"invalid value encountered"`, the debugger will most likely drop you on a line like the following:

```python
variables = ufunc(*ufunc_args, **ufunc_kwargs)
```

Type each of the following to see which function is of concern, and what its arguments are:

```
p ufunc
p ufunc_args
p ufunc_kwargs
```

With this output, it should be possible to determine which is the problematic argument.

> For example, one might have the following:
>
> ```
> (Pdb) p ufunc
> <ufunc 'true_divide'>
> (Pdb) p ufunc_args
> [array([4.34649939e-04, 9.66933210e-07]), array([0., 0.])]
> (Pdb) p ufunc_kwargs
> {}
> ```
>
> In this case we see that the operation being performed is
>
> ```python
> array([4.34649939e-04, 9.66933210e-07]) / array([0., 0.])
> ```

> which is clearly problematic. We now need to figure out why the second argument is zero, since presumably this is unintented.

To determine why the problematic argument has the value it has, we can print its expression graph:

```
theano.printing.debugprint(node.inputs[k])
```
where we replace `k` by the index of the argument we want to inspect. (One can also do `theano.printing.debugprint(node)` to get the graph of all inputs, but that tends to be overly verbose).

> Continuing with the example from above, we get the following:
>
> ```
> (Pdb) theano.printing.debugprint(node.inputs[1])
> Elemwise{true_div,no_inplace} [id A] ''   
>  |Elemwise{mul,no_inplace} [id B] ''   
>  | |Elemwise{mul,no_inplace} [id C] ''   
>  | | |TensorConstant{(1,) of 4} [id D]
>  | | |Elemwise{pow,no_inplace} [id E] ''   
>  | |   |σtilde_copy [id F]
>  | |   |TensorConstant{(1,) of 2} [id G]
>  | |TensorConstant{(1,) of 0.03125} [id H]
>  |Elemwise{exp,no_inplace} [id I] ''   
>    |logτtilde_copy [id J]
> ```
>
> Translated into math, this is
> $$ \frac{4 \cdot \tt{σtilde}^2 \cdot 0.03125}{\exp(\tt{logτtilde})} $$
> We see two possible explanations:
> - Either `σtilde` is 0 (perhaps because our prior does not exclude this value);
> - Or `logτtilde` is very large, and the exponential makes it numerically infinity.

With any luck, once we know the mathematical expression that is causing the problem, we can find it within our model. It may well be enough to identify the problem. If not, now we know exactly where to look and can use the usual `theano_shim.print` statements within our own code to track it down further.



## Situations where I've had to use this:

- The cost graph evaluates without issue, but taking its gradients produces an error (e.g. “RuntimeWarning:divide by zero”). Because this only happens when evaluating the gradient, it relates to code auto-generated by Theano – we therefore can't place a breakpoint in an astute location.

## More information

For more information on setting warning filters, see [Python's documentation](https://docs.python.org/3/library/warnings.html#warning-filter).

For more Theano debugging tips and options, see its documentation page for [advanced usage](https://theano-pymc.readthedocs.io/en/latest/crei2013/advanced_theano.html#debugging).